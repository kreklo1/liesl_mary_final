---
title: "Liesl Mary Final"
output:
  flexdashboard::flex_dashboard:
    theme:
      bg: "#fcf7e9"
      fg: "#d41495" 
      primary: "#d41495"
runtime: shiny
---


```{r libraries and data, include = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)
library(emojifont)
library(ggtext)
library(leaflet)
library(sf)
library(tidyverse)
library(shiny)
library(readr)
library(jsonlite)
library(wordcloud)
library(tidytext)
library(wordcloud2)
library(AER)
library(kableExtra)
library(beepr)
library(shinyWidgets)


```


```{r data entry, include=FALSE}
airbnb_data <- read_csv("airbnb_data.csv")

rats <- read_csv("Rat_Sightings_20240507.csv")|>
  filter(Latitude!="NA",
         Longitude!="NA")

parks <- read_csv("Parks_Properties_20240507.csv")
parks_sf <- st_as_sf(parks, wkt = "multipolygon")


url<- "https://data.cityofnewyork.us/resource/fi97-k4k6.json"

farmers_markets <- fromJSON(url)|>
  mutate(latitude=as.numeric(latitude),
         longitude=as.numeric(longitude))



manhattan_lat_range <- c(40.70, 40.88)
manhattan_lon_range <- c(-74.02, -73.93)

brooklyn_lat_range <- c(40.57, 40.74)
brooklyn_lon_range <- c(-74.04, -73.82)

queens_lat_range <- c(40.53, 40.79)
queens_lon_range <- c(-73.96, -73.71)

bronx_lat_range <- c(40.79, 40.92)
bronx_lon_range <- c(-73.93, -73.73)

staten_island_lat_range <- c(40.48, 40.65)
staten_island_lon_range <- c(-74.27, -74.04)

airbnb_data <- read_csv("airbnb_data.csv")


airbnb_with_boroughs<-airbnb_data|>
  mutate(borough = ifelse(airbnb_data$Latitude >= manhattan_lat_range[1] & airbnb_data$Latitude <= manhattan_lat_range[2] &
                                airbnb_data$Longitude >= manhattan_lon_range[1] & airbnb_data$Longitude <= manhattan_lon_range[2],
                              "Manhattan",
                              ifelse(airbnb_data$Latitude >= brooklyn_lat_range[1] & airbnb_data$Latitude <= brooklyn_lat_range[2] &
                                       airbnb_data$Longitude >= brooklyn_lon_range[1] & airbnb_data$Longitude <= brooklyn_lon_range[2],
                                     "Brooklyn",
                                     ifelse(airbnb_data$Latitude >= queens_lat_range[1] & airbnb_data$Latitude <= queens_lat_range[2] &
                                              airbnb_data$Longitude >= queens_lon_range[1] & airbnb_data$Longitude <= queens_lon_range[2],
                                            "Queens",
                                            ifelse(airbnb_data$Latitude >= bronx_lat_range[1] & airbnb_data$Latitude <= bronx_lat_range[2] &
                                                     airbnb_data$Longitude >= bronx_lon_range[1] & airbnb_data$Longitude <= bronx_lon_range[2],
                                                   "Bronx",
                                                   ifelse(airbnb_data$Latitude >= staten_island_lat_range[1] & airbnb_data$Latitude <= staten_island_lat_range[2] &
                                                            airbnb_data$Longitude >= staten_island_lon_range[1] & airbnb_data$Longitude <= staten_island_lon_range[2],
                                                      "Staten Island", "No Borough"))))))


rats <- read_csv("Rat_Sightings_20240507.csv")|>
  filter(Latitude!="NA",
         Longitude!="NA")

parks <- read_csv("Parks_Properties_20240507.csv")
parks_sf <- st_as_sf(parks, wkt = "multipolygon")


url<- "https://data.cityofnewyork.us/resource/fi97-k4k6.json"

farmers_markets <- fromJSON(url)|>
  mutate(latitude=as.numeric(latitude),
         longitude=as.numeric(longitude))

rats_graph<-rats|>
  sample_n(225)  |>
  select(Latitude, Longitude) 


airbnb_parsed <- airbnb_data |>
  select(Name, Title, Id, `Listing URL`, Price, Beds, Baths, Bedrooms, `Average Rating`, `Number of Reviews`, `More Details`, `Listing Type`, `Room Type Category`) |>
  mutate(price_parsed = parse_number(Price))
```

About
==========================

Column 
-------------------------

**About our Project**

For our final project the goal was to scrape data from the internet and tell a story about it using the skills and tools we have acquired this semester in Data Science 2. Inspired by our project for Data Science 1 last semester, we decided to scrape the Airbnb website to acquire data on rentals in New York City. Alongside the Airbnb data we also used our data set from last semester that reports locations of rat sightings in NYC, a novel data set that includes locations of farmers markets in NYC, and finally, another novel data set that includes locations of parks in NYC. Through this project we will show where all of the Airbnb rentals are in NYC as well as where they are in relationship to rats, farmers markets, and parks. We have also included a word cloud to show the most prevalent words used in titles of Airbnbs. Next we will have two different interactive maps that show summary statistics for different numeric variables for each borough. Lastly we will share our personal favorites. We hope you'll enjoy following along as we squeak out the answers to our questions about Airbnb's in NYC!

Column 
-------------------------

```{r}
leaflet() |>
    addTiles() |>
    setView(lng = mean(airbnb_data$Longitude), lat = mean(airbnb_data$Latitude), 
            zoom = 10) |> 
    addCircleMarkers(data = airbnb_data,
        lat = ~ Latitude, 
        lng = ~ Longitude, 
        popup = ~ Name, 
        radius = ~ 10,  
        weight = 3,
        color = "hotpink", 
        fillColor = "pink")
```

Airbnb with Other Variable
==========================
```{r interactive map, echo = FALSE}
rat_icon <- makeIcon(
  iconUrl = "https://icons.iconarchive.com/icons/google/noto-emoji-animals-nature/256/22251-rat-icon.png",
  iconWidth = 28,
  iconHeight = 28
)

carrot_icon <- makeIcon(
  iconUrl = "https://images.emojiterra.com/google/noto-emoji/unicode-15.1/color/svg/1f955.svg",
  iconWidth = 29,
  iconHeight = 29
)

```

```{r}

ui <- fluidPage(
  tags$h2("Map with Airbnb Data and other Amenities"),
  tags$p("Check the boxes of the variables you want to see added to the map."),
  checkboxInput("overlay_parks", "Parks", FALSE),
  checkboxInput("overlay_rats", "Rats", FALSE),
  checkboxInput("overlay_markets", "Farmer's Markets", FALSE),
  leafletOutput("map")
)

server <- function(input, output, session) {
  output$map <- renderLeaflet({
    house_icon <- makeIcon(
      iconUrl = "https://www.iconeasy.com/icon/png/System/Vista%20General/house.png",
      iconWidth = 29,
      iconHeight = 29
    )

    map <- leaflet() |>
      addTiles() |>
      setView(lng = -74.00, lat = 40.71, zoom = 12) |>
      addMarkers(data = airbnb_data, lng = ~Longitude, lat = ~Latitude, icon = house_icon,
                  popup = ~paste("<a href='", `Listing URL`, "'><b>", Title, "</b></a>", "</br>", Name, "</br>", Price, Qualifier))

    if (input$overlay_parks) {
      map <- map |>
        addPolygons(data = parks_sf, color = "deeppink", popup = ~paste(SIGNNAME))
    }

    if (input$overlay_rats) {
      map <- map |>
      addMarkers(data=rats_graph, lng=~Longitude, lat=~Latitude, icon = rat_icon, popup = ~paste("squeak squeak:)"))
    }
    
    if (input$overlay_markets) {
      map <- map |>
      addMarkers(data=farmers_markets, lng=~longitude, lat=~latitude, icon = carrot_icon, popup = ~paste(marketname, "</br>", daysoperation, hoursoperations))
    }

    map
  })
}

shinyApp(ui, server)


```


Description Word Analysis
==========================
```{r}
selectInput("choice", "Select an option:",
            choices = c("Name", "Title"))

renderWordcloud2({
  if (input$choice == "Name") {
    word <- airbnb_data |>
      select(Name) |>
      mutate(Name = str_to_lower(Name),
             word = str_split(Name, "\\s+")) |>
      unnest(word) |>
      mutate(word = str_remove_all(word, "[^[:alpha:]]")) |>
      anti_join(stop_words) |>
      count(word, sort=TRUE) |>
      slice(2:n)
  } else if (input$choice == "Title") {
    word <- airbnb_data |>
      select(Title) |>
      mutate(Title = str_to_lower(Title),
             title = str_split(Title, "\\s+")) |>
      unnest(title) |>
      mutate(word = str_remove_all(title, "[^[:alpha:]]")) |>
      anti_join(stop_words) |>
      count(title, sort=TRUE) |>
      slice(2:n)
  }
  
  pinkalicious <- c("#FF6FFF", "#FF5D99", "hotpink", "#FFCFF7", "deeppink")
  
  wordcloud2(data = word, size = 1, color = pinkalicious)
})

```


Summary Statistics By Borough
==========================
```{r, include = FALSE}
summary_stats_data <- airbnb_with_boroughs|>
  mutate(Price=parse_number(Price))

summary_stats_data |> 
 ggplot()+
  geom_boxplot(aes(y = borough, x = Price), color="deeppink") +
  theme_minimal() +
  labs(y = "Borough", x = "Price") 
#Replace Price with "Beds", "Baths", `Average Rating`,`Number of Reviews`, `Cleanliness Rating`, etc.
#Note that Staten Island only has one listing
```

```{r, echo=FALSE}
titlePanel("Summary Statistics by Borough")

inputPanel(
  selectInput("x", label = "x-axis variable:",
    choices = c("Price" = "Price",
                "⭐ Review" = "Average Rating",
                "Number of Reviews" = "Number of Reviews"
                ))
)

renderPlot({

 ggplot(data = summary_stats_data)+
  geom_boxplot(aes( x = .data[[input$x]], y = borough), 
               color="deeppink") +
  labs(y = "Borough", x = "Price") 
  
})
```

Two Variable Comparison
==========================
```{r, echo=FALSE}
titlePanel("Two Variable Comparison")

inputPanel(
  selectInput("x", label = "x-axis variable:",
    choices = c("Price" = "price_parsed",
                "⭐ Review" = "Average Rating",
                "Number of Reviews" = "Number of Reviews")),
    selectInput("y", label = "y-axis variable:",
    choices = c("Price" = "price_parsed",
                "⭐ Review" = "Average Rating",
                "Number of Reviews" = "Number of Reviews"))
)

renderPlot({

        ggplot(airbnb_parsed, aes(x = .data[[input$x]], y =  .data[[input$y]])) +
          geom_jitter(size = 2, alpha = 0.25, color = "hotpink") +
          geom_smooth(se = FALSE)
})
```

Our Favorites
==========================
## Column

**Mary's Favorite**

I chose a condo in Manhattan with the Name "Cozy & Chic, Chelsea High Line Studio" as my favorite AirBnb in New York City. As you can see from the table below, this AirBnb is a Guest Favorite, and is very highly rated.

```{r, echo=FALSE}
mary_airbnb<-airbnb_with_boroughs|>
  filter(Name=="New! Cozy & Chic, Chelsea High Line Studio")|>
  select("Name", "Title", "Price", "Baths", "Bedrooms", "Average Rating", "Number of Reviews", "Room Type Category", "More Details", "borough")

kable(mary_airbnb, format = "html")|>
  kable_styling()
```

Below you can see where this airbnb is in relation to others. As you can see, it is the perfect location so you are not directly in the middle of everything, but you still are super close and conveniently located! The views are also great from the condo. Check out [this link](https://www.airbnb.com/rooms/808386228706904148?source_impression_id=p3_1715360488_%2FcmH40MOuzoem%2Bl9) to learn more about it!

```{r, echo=FALSE}
rat_icon <- makeIcon(
  iconUrl = "https://icons.iconarchive.com/icons/google/noto-emoji-animals-nature/256/22251-rat-icon.png",
  iconWidth = 28,
  iconHeight = 28
)

carrot_icon <- makeIcon(
  iconUrl = "https://images.emojiterra.com/google/noto-emoji/unicode-15.1/color/svg/1f955.svg",
  iconWidth = 29,
  iconHeight = 29
)

star_icon<-makeIcon(iconUrl="https://www.clipartmax.com/png/full/85-851033_filesolid-bright-green-star-1-green-star-no-background.png", iconWidth=48, iconHeight=48)

renderLeaflet({
leaflet(width = "100%", height = 600) |>
  addTiles() |>
  setView(lng = -74.00, lat = 40.74, zoom = 12)|>
  addMarkers(data=farmers_markets, lng=~longitude, lat=~latitude, icon = carrot_icon, popup = ~paste(marketname, "</br>", daysoperation, hoursoperations))|>
  addMarkers(data=rats_graph, lng=~Longitude, lat=~Latitude, icon = rat_icon, popup = ~paste("squeak squeak:)"))|>
  addPolygons(data=parks_sf, color="deeppink", popup = ~paste(SIGNNAME))|>
  addMarkers(lng = -74.00579, lat = 40.74473, popup = "Mary's Favorite!", 
               icon = star_icon)
})
beep(sound = 11)
```

Next time you are looking for a place to stay in New York City, consider splurging a bit on this beautiful AirBnb! Sadly, none of the rats in our sampling of rat sightings were spotted around here, so no bro-dents, however, there are 3 farmer's markets and several parks nearby so lots to do and explore!


## Column



Conclusion
==========================


